---
id: 5895f70df9fc0f352b528e69
title: 如何使用 Passport 策略
challengeType: 2
forumTopicId: 301555
dashedName: how-to-use-passport-strategies
---

# --description--

在提供的 `index.pug` 檔案中，有一個登入表單。因為行內 JavaScript `if showLogin` 的關係，該表單被隱藏，且表單在其後縮排。

在該頁面的 `res.render` 中，將一個新的變數 `showLogin: true` 添加到物件。當你重新整理你的頁面時，你應該會看到表單！這個表單設定為在 `/login` 上 **POST**。所以，你應該在這裡設定以接受 POST 請求並驗證使用者。

針對此挑戰，你應該為路由 `/login` 添加以接受 POST 請求。若要在此路由上進行驗證，你需要先添加一個中介層，然後再傳送回應。這只需在回應之前傳入另一個帶有中介層的引數即可。要使用的中介層是 `passport.authenticate('local')`。

`passport.authenticate` 也可以接受一些選項作為引數，例如 `{ failureRedirect: '/' }`，這非常有用，所以務必將它加入。使用中介層後（只有當驗證中介層通過時才會呼叫）新增一個回應，將使用者重新導向到 `/profile`。也新增該路由，並讓它呈現視圖 `profile.pug`。

如果驗證成功，使用者物件將會被存檔在 `req.user`。

此時，如果你在表單中輸入使用者名稱和密碼，應該會重新導向到首頁 `/`，且你的伺服端主控台應該會顯示 `'User {USERNAME} attempted to log in.'`，因為我們目前無法登入尚未註冊的使用者。

當你認為已經正確完成時，提交你的頁面。如果你遇到錯誤，你可以<a href="https://forum.freecodecamp.org/t/advanced-node-and-express/567135#how-to-use-passport-strategies-7" target="_blank" rel="noopener noreferrer nofollow">查看至此為止完成的專案</a>。

# --hints--

所有步驟都應該在 `server.js` 中正確實作。

```js
  const url = new URL("/_api/server.js", code);
  const res = await fetch(url);
  const data = await res.text();
  assert.match(
    data,
    /showLogin:( |)true/,
    'You should be passing the variable "showLogin" as true to your render function for the homepage'
  );
  assert.match(
    data,
    /failureRedirect:( |)('|")\/('|")/,
    'Your code should include a failureRedirect to the "/" route'
  );
  assert.match(
    data,
    /login[^]*post[^]*local/,
    'You should have a route for login which accepts a POST and passport.authenticates local'
  );
```

對 `/login` 的 POST 請求應正確重新導向到 `/`。

```js
  const url = new URL("/login", code);
  const res = await fetch(url, { method: 'POST' });
  const data = await res.text();
  assert.match(
    data,
    /Looks like this page is being rendered from Pug into HTML!/,
    'A login attempt at this point should redirect to the homepage since we do not have any registered users'
  );
```

