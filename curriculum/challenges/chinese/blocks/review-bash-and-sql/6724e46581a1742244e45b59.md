---
id: 6724e46581a1742244e45b59
title: Bash 和 SQL 复习
challengeType: 31
dashedName: review-bash-and-sql
---

# --description--

## 数据库归一化

这是组织关系数据库以减少数据冗余并提高完整性的过程。

它的优点包括：

- 最小化重复的 `data`，这可以节省 `storage` 并减少不一致性。
- 通过使用主键和外键来强制执行数据完整性。
- 让数据库更易于维护和理解。

### 范式

- **1NF（第一范式）**
  - 每个单元格包含一个单一的（原子的）值。
  - 每个记录都是唯一的（由主键强制执行）。
  - 行/列的顺序无关紧要。
  - 示例：将多个电话号码从 `students` 表格移动到单独的 `student_phones` 表格中。

- **2NF（第二范式）**
  - 满足 1NF 要求。
  - 没有**部分依赖**：每个非主键属性必须依赖于整个复合主键。
  - 示例：将 `orders` 表格拆分为 `order_header` 和 `order_items`，以避免属性仅依赖于部分密钥。

- **3NF（第三范式）**
  - 满足 2NF 要求。
  - 没有**传递依赖**：非关键属性不能依赖于其他非关键属性。
  - 示例：将 `city_postal_code` 移动到 `cities` 表格，而不是与每个订单一起存储。

- **BCNF（Boyce-Codd 范式）**
  - 满足 3NF 要求。
  - 每个决定因素（函数依赖的左侧）必须是超键。

**提示**：在大多数设计中，目标是达到 3NF，以实现完整性和性能的良好平衡。

## 关键 SQL 概念

- SQL 是一种用于与关系数据库通信的结构化查询语言。
- **基本命令** → `SELECT`、`INSERT`、`UPDATE`、`DELETE`、`CREATE TABLE`、`ALTER TABLE` 等。
- `Joins` → 组合来自多个表格的 数据（`INNER JOIN`、`LEFT JOIN`、`RIGHT JOIN`、`FULL JOIN`）。

## 在 Bash 中运行 SQL 命令

你可以使用 PostgreSQL 的 `psql` 命令行客户端或其他数据库的类似工具直接从命令行运行 SQL 命令。

例如，要在 PostgreSQL 中运行一个 SQL 文件：

```bash
psql -U username -d database_name -c "SELECT * FROM students;"
```

你也可以直接执行 MySQL 命令：

```bash
mysql -u username -p database_name -e "SELECT * FROM students;"
```

### 从文件运行 SQL

```bash
# PostgreSQL
psql -U username -d database_name -f script.sql

# MySQL
mysql -u username -p database_name < script.sql
```

### 在 Bash 脚本中嵌入 SQL

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Insert student data
psql -U "$DB_USER" -d "$DB_NAME" -c \
"INSERT INTO students (name, age, major) VALUES ('Alice', 20, 'CS');"
```

### SQL 中变量的使用

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"
STUDENT_NAME="Bob"
AGE=21

psql -U "$DB_USER" -d "$DB_NAME" -c \
"INSERT INTO students (name, age) VALUES ('$STUDENT_NAME', $AGE);"
```

**提示**：清理变量以避免 SQL 注入。

## 在 Bash 中检索和使用 SQL 查询结果

当你通过 `psql` 运行 SQL 查询时，你可以在你的 Bash 脚本中**捕捉**并**处理**返回的值。

### 捕获单个值

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get total student count
STUDENT_COUNT=$(psql -U "$DB_USER" -d "$DB_NAME" -t -A -c \
"SELECT COUNT(*) FROM students;")

echo "Total students: $STUDENT_COUNT"
```

输出 → 42

### 检索多个列

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get top 3 students' names and ages
RESULTS=$(psql -U "$DB_USER" -d "$DB_NAME" -t -A -F"," -c \
"SELECT name, age FROM students LIMIT 3;")

echo "Top 3 students:"
echo "$RESULTS"
```

输出

```bash
Alice,20
Bob,21
Charlie,22
```

### 循环遍历查询结果

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get student names and majors
psql -U "$DB_USER" -d "$DB_NAME" -t -A -F"," -c \
"SELECT name, major FROM students;" | while IFS="," read -r name major
do
    echo "Student: $name | Major: $major"
done
```

输出形状

```bash
Student: Alice | Major: CS
Student: Bob   | Major: Math
Student: Carol | Major: Physics
```

## SQL 注入

这是一种网络安全漏洞，攻击者将恶意 SQL 代码插入到输入字段中以操纵数据库。

这可能导致诸如以下的高风险操作：

- 绕过认证。
- 窃取敏感数据。
- 修改或删除记录。

SQL 注入攻击的示例：

```sql
SELECT * FROM users WHERE username = ' " " OR "1"="1" -- ' AND password = 'anything';
```

此查询将返回所有用户，因为条件 `OR "1"="1"` 始终为真，允许攻击者绕过登录检查。

### 防止 SQL 注入

1. **使用预处理语句**：这些将 SQL 代码与数据分开，防止注入。以下是一个示例（Node.js 使用 pg）：

    ```sql
    client.query('SELECT * FROM users WHERE username = $1 AND password = $2', [username, password]);
    ```

2. **输入验证**：清理并验证所有用户输入，以确保它们符合预期的形式。

3. **最小权限**：使用具有应用所需最低权限的数据库账户。

**注意**：切勿授予应用账户管理员权限。

## N+1 问题

当一个应用发出一个查询以检索一个包含 N 个项的列表，然后对每个项发出额外的查询以检索相关数据时，就会发生 N+1 问题，导致总共发出 N+1 个查询。

**为什么这很糟糕**

- 每个查询都会添加网络和处理额外开销。
- 多个小查询比一个优化的查询更慢。

### N+1 模式示例

```sql
-- 1: Get list of orders
SELECT * FROM orders LIMIT 50;

-- N: For each order, get customer
SELECT * FROM customers WHERE customer_id = ...;
```

**方案**：使用 `JOINs` 或其他基于集合的操作。

```sql
SELECT 
  orders.order_id,
  orders.product,
  orders.quantity,
  customers.customer_id,
  customers.name,
  customers.email,
  customers.address
FROM orders
JOIN customers 
  ON orders.customer_id = customers.customer_id
WHERE orders.order_id IN (SELECT order_id FROM orders LIMIT 50);
```

始终寻找将相关数据合并到单个查询中的机会。

# --assignment--

复习 Bash 和 SQL 主题及概念。
