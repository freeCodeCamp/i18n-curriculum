---
id: 6724e417419c2f211bb41bfc
title: Bash 腳本複習
challengeType: 31
dashedName: review-bash-scripting
---

# --description--

## Bash 腳本基礎

- **Bash 腳本撰寫**：在一個檔案中撰寫一連串的 Bash 指令，然後你可以使用 Bash 來執行該檔案的內容。
- **Shebang**：腳本開頭的註解行（例如 `#!/bin/bash`），用來顯示應該使用哪個直譯器來執行該腳本。

  ```bash
  #!/bin/bash
  ```

- **變數指派**：使用語法 `variable_name=value` 來實例化變數。

  ```bash
  servers=("prod" "dev")
  ```

- **變數產生規則**：使用 `VARIABLE_NAME=VALUE` 語法創建變數。等號（`=`）兩邊不得有空格。如果值包含空格，請使用雙引號。

  ```bash
  NAME=John
  MESSAGE="Hello World"
  COUNT=5
  TEXT="The next number is, "
  ```

- **變數使用**：在變數名稱前加上 `$` 以存取變數值。

  ```bash
  echo $NAME
  echo "The message is: $MESSAGE"
  ```

- **變數插值**：使用 `$variable_name` 在字串和指令中存取變數的值。

  ```bash
  TEXT="The next number is, "
  NUMBER=42
  echo $TEXT B:$NUMBER
  echo $TEXT I:$NUMBER
  
  echo "Pulling $server"
  rsync --archive --verbose $server:/etc/nginx/conf.d/server.conf configs/$server.conf
  ```

- **變數範圍**：Shell 腳本從上到下執行，所以變數只能在它們被創建的下方使用。

  ```bash
  NAME="Alice"
  echo $NAME
  ```

- **使用者輸入**：使用 `read` 從使用者接收輸入並將其儲存在變數中。

  ```bash
  read USERNAME
  echo "Hello $USERNAME"
  ```

- **註解**：為你的腳本添加註解，使用 `#` 後接你的註解文字。
  - 單行註解以 `#` 開頭，並持續到該行結尾。
  - Shell 會忽略註解，且不會影響腳本執行。

  ```bash
  # This is a single-line comment
  NAME="John"  # Comment at end of line
  ```

- **多行註解**：使用冒號和引號將程式碼區塊註解起來。

  ```bash
  : '
  This is a multi-line comment
  Everything between the quotes is ignored
  Useful for debugging or documentation
  '
  ```

- **內建指令與說明**：
  - 使用 `help` 查看內建 bash 指令的列表
  - 使用 `help <command>` 來取得關於特定內建指令的資訊
  - 有些指令（例如 `if`）是內建指令，沒有 man 頁面。
  - 內建指令由 shell 直接執行，而非作為外部程式。
  - 使用 `help function` 查看有關建立函式（程式） 的資訊

  ```bash
  help
  help if
  help function
  ```

- **尋找指令位置**：使用 `which` 來定位執行檔安裝的位置。
  - 顯示可執行檔的完整路徑
  - 有助於尋找直譯器位置（例如 bash）
  - 有助於驗證將執行哪個版本的指令

  ```bash
  which bash
  which python
  which ls
  ```

- **手冊頁**：使用 `man` 存取指令的詳細文件。
  - 提供關於指令使用的完整資訊
  - 顯示所有可用的選項和範例
  - 使用方向鍵導航，按 q 退出
  - 並非所有指令都有手冊頁（內建指令改用 `help`）

  ```bash
  man echo
  man ls
  man bash
  ```

- **說明旗標**：許多指令支援 `--help` 以快速取得說明資訊。
  - 快速取用的手冊頁替代方案
  - 顯示指令語法和常見選項
  - 並非所有指令都支援此旗標（有些可能會顯示錯誤）

  ```bash
  ls --help
  chmod --help
  mv --help
  ```

- **Echo 指令選項**：`echo` 指令支援各種選項：
  - `-e` 選項啟用反斜線轉義的解釋
  - `\n` 產生新的一行
  - 只有當值被引號包住時，空行才會被列印
  - 有助於建立格式化輸出和程式標題

  ```bash
  echo -e "Line 1\nLine 2"
  echo ""
  echo -e "\n~~ Program Title ~~\n"
  echo "Line 1\nLine 2"
  ```

- **腳本引數**：程式可以接受可透過 `$` 變數存取的引數。
  - `$*` 列印傳遞給腳本的所有引數
  - `$@` 將所有傳遞給腳本的引數以獨立的帶引號字串列印出來
  - `$<number>` 依位置存取特定引數（例如，`$1`、`$2`、`$3`）

  ```bash
  echo $*
  echo $@
  echo $1
  echo $2
  ```

## 雙中括號表達式 `[[ ]]`

- **雙括號語法**：使用 `[[ ]]` 進行條件測試和樣式匹配。
  - 括號內及運算子兩側必須有空格
  - 根據測試結果傳回離開狀態 0（true）或 1（false）

  ```bash
  [[ $variable == "value" ]]
  [[ $number -gt 10 ]]
  [[ -f filename.txt ]]
  ```

- **字串比較運算子**：在 `[[ ]]` 中使用各種運算子比較字串。
  - `==`（相等）：測試兩個字串是否相同
  - `!=`（不相等）：測試兩個字串是否不同
  - `<`（字典序較小）：字串依字母順序比較
  - `>`（字典序較大）：字串按字母順序比較

  ```bash
  [[ "apple" == "apple" ]]
  [[ "apple" != "orange" ]]
  [[ "apple" < "banana" ]]
  [[ "zebra" > "apple" ]]
  ```

- **數值比較運算子**：使用特定的數值運算子比較數字。
  - `-eq`（相等）：數值相等比較
  - `-ne`（不相等）：數值不相等比較
  - `-lt`（小於）：數值小於比較
  - `-le`（小於或相等）：數值小於或相等比較
  - `-gt`（大於）：數值大於比較
  - `-ge`（大於或相等）：數值大於或相等比較

  ```bash
  [[ $number -eq 5 ]]
  [[ $count -ne 0 ]]
  [[ $age -ge 18 ]]
  [[ $score -lt 100 ]]
  ```

- **邏輯運算子**：使用邏輯運算子結合多個條件。
  - `&&`（且）：兩個條件都必須為真
  - `||`（或）：至少有一個條件必須為真
  - `!` (not)：否定條件（使 true 變成 false，false 變成 true）

  ```bash
  [[ $age -ge 18 && $age -le 65 ]]
  [[ $name == "John" || $name == "Jane" ]]
  [[ ! -f missing_file.txt ]]
  ```

- **檔案測試運算子**：測試檔案屬性和存在性。
  - `-e file`：如果檔案存在則為 True
  - `-f file`：如果檔案存在且為一般檔案，則為真
  - `-d file`：如果檔案存在且是目錄，則為 True
  - `-r file`：如果檔案存在且可讀，則為 True
  - `-w file`：如果檔案存在且可寫入，則為 True
  - `-x file`：如果檔案存在且可執行，則為 True
  - `-s file`：如果檔案存在且大小大於零，則為真

  ```bash
  [[ -e /path/to/file ]]
  [[ -f script.sh ]]
  [[ -d /home/user ]]
  [[ -x program ]]
  ```

- **使用 `=~` 進行樣式匹配**：使用正則表達式進行進階樣式匹配。
  - `=~` 運算子啟用正則表達式樣式比對
  - 使用正則表達式元字元時，樣式不應加引號
  - 支援完整的正規表達式語法
  - 預設區分大小寫

  ```bash
  [[ "hello123" =~ [0-9]+ ]]
  [[ "email@domain.com" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]
  [[ "filename.txt" =~ \.txt$ ]]
  ```

- **變數存在性測試**：檢查變數是否已設定或為空。
  - 測試變數是否為空：`[[ ! $variable ]]`

  ```bash
  [[ ! $undefined_var ]]
  ```

## 雙重小括弧表達式 `(( ))`

- **算術運算**：使用 `(( ))` 進行數學計算和數值比較。
  - 使用 C 風格語法評估算術運算式
  - 在雙重小括弧內，變數不需要 `$` 前置式
  - 如果結果非零，傳回離開狀態 0；如果結果為零，傳回離開狀態 1。
  - 支援所有標準算術運算子

  ```bash
  (( result = 10 + 5 ))
  (( count++ ))
  (( total += value ))
  ```

- **算術運算子**：`(( ))` 中可用的數學運算子。
  - `+`（加法）：將兩個數字相加
  - `-`（減法）：從第一個數字中減去第二個數字
  - `*`（乘法）：將兩個數字相乘
  - `/`（除法）：將第一個數字除以第二個數字（整數除法）
  - `%`（取餘數）：除法後的餘數
  - `**`（次方運算）：將第一個數字引發到第二個數字的次方

  ```bash
  (( sum = a + b ))
  (( diff = x - y ))
  (( product = width * height ))
  (( remainder = num % 10 ))
  (( power = base ** exponent ))
  ```

- **指定運算子**：使用算術指定運算子修改變數。
  - `=`（指派）：將值指定給變數
  - `+=`（加並指定）：將值加到變數
  - `-=`（減去並指定）：從變數中減去值
  - `*=`（乘法並指定）：將變數乘以值
  - `/=`（除以並指定）：將變數除以值
  - `%=`（取餘數並指定）：將變數設值為餘數

  ```bash
  (( counter = 0 ))
  (( counter += 5 ))
  (( total -= cost ))
  (( area *= 2 ))
  (( value /= 3 ))
  ```

- **遞增與遞減運算子**：將變數增加或減少一。
  - `++variable`（前置遞增）：使用前遞增
  - `variable++`（後置遞增）：使用後遞增
  - `--variable`（前置遞減）：使用前遞減
  - `variable--`（後置遞減）：使用後遞減

  ```bash
  (( ++counter ))
  (( index++ ))
  (( --remaining ))
  (( attempts-- ))
  ```

- **比較運算子**：使用算術比較來比較數字。
  - `==`（相等）：數字相等
  - `!=`（不相等）：數字不相等
  - `<`（小於）：第一個數字小於第二個數字
  - `<=`（小於或相等）：第一個數字小於或相等於第二個數字
  - `>`（大於）：第一個數字大於第二個數字
  - `>=`（大於或相等）：第一個數字大於或相等於第二個數字

  ```bash
  (( age >= 18 ))
  (( score < 100 ))
  (( count == 0 ))
  (( temperature > freezing ))
  ```

- **邏輯運算子**：結合算術條件。
  - `&&`（且）：兩個條件都必須為真
  - `||`（或）：至少有一個條件必須為真
  - `!` (not)：否定條件

  ```bash
  (( age >= 18 && age <= 65 ))
  (( score >= 90 || extra_credit > 0 ))
  (( !(count == 0) ))
  ```

- **以 bit 為單元逐一操作的運算子**：對整數執行以位元層級的操作行為。
  - `&`（以 bit 為單元逐一 AND）：對每個位元進行 AND 操作
  - `|`（以 bit 為單元逐一 OR）：對每個位元進行 OR 操作
  - `^`（以 bit 為單元逐一 XOR）：對每個位元進行 XOR 操作行為
  - `~`（以 bit 為單元逐一 NOT）：反轉所有位元
  - `<<`（左移）：將位元向左移動
  - `>>`（右移）：將位元向右移動

  ```bash
  (( result = a & b ))
  (( flags |= new_flag ))
  (( shifted = value << 2 ))
  ```

- **條件（三元）運算子**：使用 `condition ? true_value : false_value` 語法。
  - 提供一種根據條件指定值的簡潔方式
  - 類似於 C 類語言中的三元運算子
  - 評估條件並傳回兩個值中的一個

  ```bash
  (( result = (score >= 60) ? 1 : 0 ))
  (( max = (a > b) ? a : b ))
  (( sign = (num >= 0) ? 1 : -1 ))
  ```

- **算術運算的命令替換**：使用 `$(( ))` 來取得算術結果。
  - 傳回算術表達式的結果字串
  - 可用於指派或命令引數中
  - 適用於需要在其他地方使用的計算

  ```bash
  result=$(( 10 + 5 ))
  echo "The answer is $(( a * b ))"
  array_index=$(( RANDOM % array_length ))
  ```

## 控制流程與條件判斷

- **條件述語**：使用 `if` 述語根據條件執行程式碼。
  - 基本語法：`if [[ CONDITION ]] then STATEMENTS fi`
  - 完整語法：`if [[ CONDITION ]] then STATEMENTS elif [[ CONDITION ]] then STATEMENTS else STATEMENTS fi`
  - 可以同時使用 `[[ ]]` 和 `(( ))` 表達式來處理不同型別的條件。
  - **elif (else if)**：選用，可重複多次以依序測試其他條件
  - **else**：選用，當所有先前條件皆為假時執行
  - 可以在同一條件串鏈中混用雙小括弧 `(( ... ))` 和雙中括弧 `[[ ... ]]`

  ```bash
  if (( NUMBER <= 15 ))
  then
      echo "B:$NUMBER"
  elif [[ $NUMBER -le 30 ]]
  then
      echo "I:$NUMBER"
  elif (( NUMBER < 46 ))
  then
      echo "N:$NUMBER"
  elif [[ $NUMBER -lt 61 ]]
  then
      echo "G:$NUMBER"
  else
      echo "O:$NUMBER"
  fi
  ```

## 指令執行與處理程序控制

- **指令分隔**：使用分號（`;`）在同一行中執行多個指令。
  - 命令從左到右依序執行
  - 每個指令的 `exit` 狀態都可以單獨檢查。

  ```bash
  [[ 4 -ge 5 ]]; echo $?
  ls -l; echo "Done"
  ```

- **離開狀態**：每個指令都有一個離開狀態，用來顯示成功或失敗。
  - 使用 `$?` 存取最後一個指令的離開狀態
  - 離開狀態 `0` 表示成功（true/無錯誤）
  - 任何非零的 `exit` 狀態代表失敗（發生錯誤／錯誤）。
  - 常見錯誤代碼：`127`（找不到指令）、`1`（一般錯誤）

  ```bash
  echo $?
  [[ 4 -le 5 ]]; echo $?
  ls; echo $?
  bad_command; echo $?
  ```

- **子殼層與指令替換**：小括弧在執行背景關係中的不同用法。
  - 單一小括弧 `( ... )` 會創建子殼層
  - `$( ... )` 執行指令替換
  - 子殼層在獨立環境中執行，且不會影響父殼層的變數。

  ```bash
  ( cd /tmp; echo "Current dir: $(pwd)" )
  current_date=$(date)
  file_count=$(ls | wc -l)
  echo "Today is $current_date"
  echo "Found $file_count files"
  ```

- **Sleep 指令**：暫停腳本執行指定秒數。
  - 適用於在腳本中建立延遲
  - 可用於小數秒延遲

  ```bash
  sleep 3
  sleep 0.5
  sleep 1
  ```

## 迴圈

- **While loops**：當條件為真時，重複執行程式碼。
  - 語法：`while [[ CONDITION ]] do STATEMENTS done`

  ```bash
  I=5
  while [[ $I -ge 0 ]]
  do
      echo $I
      (( I-- ))
      sleep 1
  done
  ```

- **Until 迴圈**：重複執行程式碼直到條件變為真。
  - 語法：`until [[ CONDITION ]] do STATEMENTS done`

  ```bash
  until [[ $QUESTION =~ \?$ ]]
  do
      echo "Please enter a question ending with ?"
      read QUESTION
  done
  until [[ $QUESTION =~ \?$ ]]
  do
      GET_FORTUNE again
  done
  ```

- **For 迴圈**：使用 `for` 迴圈搭配 `do` 和 `done` 來定義迴圈的邏輯區塊，對陣列或列表進行迭代。

  ```bash
  for server in "${servers[@]}"
  do
      echo "Processing $server"
  done
  for (( i = 1; i <= 5; i++ ))
  do
      echo "Number: $i"
  done
  for (( i = 5; i >= 1; i-- ))
  do
      echo "Countdown: $i"
  done
  for i in {1..5}
  do
      echo "Count: $i"
  done
  ```

## 陣列

- **陣列**：在單一變數中儲存多個值。
  - 使用小括弧創建陣列：`ARRAY=("value1" "value2" "value3")`
  - 透過索引存取元素：`${ARRAY[0]}`、`${ARRAY[1]}`
  - 存取所有元素：`${ARRAY[@]}` 或 `${ARRAY[*]}`
  - 陣列索引從 0 開始

  ```bash
  RESPONSES=("Yes" "No" "Maybe" "Ask again later")
  echo ${RESPONSES[0]}     # Yes          
  echo ${RESPONSES[1]}     # No         
  echo ${RESPONSES[5]}     # Index 5 doesn't exist; empty string              
  echo ${RESPONSES[@]}     # Yes No Maybe Ask again later   
  echo ${RESPONSES[*]}     # Yes No Maybe Ask again later 
  ```

- **使用 declare 進行陣列檢查**：使用 `declare -p` 查看陣列詳細資訊。
  - 顯示帶有 `-a` 旗標的陣列型別
  - 顯示所有陣列元素及其結構

  ```bash
  ARR=("a" "b" "c")
  declare -p ARR # ARR=([0]="a" [1]="b" [2]="c")
  ```

- **陣列展開**：使用 `"${array_name[@]}"` 語法將陣列展開為個別元素。

```bash
for server in "${servers[@]}"
```

## 函式（程式）

- **函式（程式）**：創建可重複使用的程式碼區塊。
  - 使用 `FUNCTION_NAME() { STATEMENTS }` 定義
  - 透過使用函式名稱來呼叫
  - 可以接受可透過 `$1`、`$2` 等存取的引數。

  ```bash
  GET_FORTUNE() {
      echo "Ask a question:"
      read QUESTION
  }
  GET_FORTUNE
  ```

- **函式引數**：函式可以接受引數，就像腳本一樣。
  - 在呼叫函式時會傳遞引數
  - 使用 `$1`、`$2` 等存取函式內的引數。
  - 使用條件邏輯來處理不同的引數

  ```bash
  GET_FORTUNE() {
      if [[ ! $1 ]]
      then
          echo "Ask a yes or no question:"
      else
          echo "Try again. Make sure it ends with a question mark:"
      fi
      read QUESTION
  }
  GET_FORTUNE
  GET_FORTUNE again
  ```

## 隨機數與數學操作

- **隨機數**：使用 `$RANDOM` 變數來產生隨機值。
  - `$RANDOM` 會產生介於 0 和 32767 之間的數字
  - 使用取模運算子限制範圍：`$RANDOM % 75`
  - 為避免零，為 1 添加：`$(( RANDOM % 75 + 1 ))`
  - 必須使用 `$(( ... ))` 語法來進行 `$RANDOM` 的計算

  ```bash
  NUMBER=$(( RANDOM % 6 ))
  DICE=$(( RANDOM % 6 + 1 ))
  BINGO=$(( RANDOM % 75 + 1 ))
  echo $(( RANDOM % 10 ))
  ```

- **隨機陣列存取**：使用隨機數來隨機存取陣列元素。
  - 在陣列範圍內產生隨機索引
  - 使用隨機索引存取陣列元素
  - 適用於從預定義的選項中隨機選擇

  ```bash
  RESPONSES=("Yes" "No" "Maybe" "Outlook good" "Don't count on it" "Ask again later")
  N=$(( RANDOM % 6 ))
  echo ${RESPONSES[$N]}
  ```

- **取模運算子**：使用 `%` 來取得除法操作的餘數。
  - 限制隨機數範圍的必要條件
  - 與 `$RANDOM` 一起使用以創建有界隨機值
  - `RANDOM % n` 會產生從 0 到 n-1 的數字

  ```bash
  echo $(( 15 % 4 ))
  echo $(( RANDOM % 100 ))
  echo $(( RANDOM % 10 + 1 ))
  ```

## 環境與系統資訊

- **環境變數**：在 shell 環境中可用的預定義變數。
  - `$RANDOM`：產生介於 0 和 32767 之間的隨機數。
  - `$LANG`：系統語言設定
  - `$HOME`：使用者主目錄路徑
  - `$PATH`：用於搜尋可執行指令的目錄
  - 使用 `printenv` 或 `declare -p` 查看全部

  ```bash
  echo $RANDOM
  echo $HOME
  echo $LANG
  printenv
  ```

- **變數檢查**：使用 `declare` 來查看和操作變數。
  - `declare -p`：列印所有變數及其值
  - `declare -p VARIABLE`：列印特定變數的詳細資訊
  - 顯示變數型別（字串、陣列等）和屬性

  ```bash
  declare -p
  declare -p RANDOM
  declare -p MY_ARRAY
  ```

- **指令型別**：bash 中可用的不同指令類別。
  - **內建指令**：由 shell 直接執行（例如 `echo`、`read`、`if`）
  - **外部指令**：系統目錄中的二進位檔案（例如，`ls`、`sleep`、`bash`）
  - **Shell 關鍵字**：語言構件（例如 `then`、`do`、`done`）
  - 使用 `type <command>` 查看指令的型別。

  ```bash
  type echo
  type ls
  type if
  type ./script.sh
  ```

## 檔案產生與管理

- **檔案產生**：使用 `touch` 來創建新的空白檔案。
  - 如果不存在，則創建新的檔案
  - 如果檔案已存在，則更新時間戳記
  - 常用於在編輯前創建腳本檔案

  ```bash
  touch script.sh
  touch bingo.sh
  touch filename.txt
  ```

## 建立與執行 Bash 腳本

- **腳本執行方法**：多種方式來執行 bash 腳本：
  - **`sh scriptname.sh`**：使用 sh shell 直譯器執行。
  - **`bash scriptname.sh`**：使用 bash shell 直譯器執行。
  - **`./scriptname.sh`**：直接執行（需要可執行權限）。

```bash
sh questionnaire.sh
bash questionnaire.sh
./questionnaire.sh
```

## 檔案權限與腳本執行

- **權限拒絕錯誤**：當使用 `./scriptname.sh` 時，如果該檔案缺少可執行權限，你可能會收到「permission denied」的錯誤。
- **檢查權限**：使用 `ls -l` 查看檔案權限。

  ```bash
  ls -l questionnaire.sh
  ```

- **權限格式**：輸出顯示權限為 `-rw-r--r--`，其中：
  - 第一個字元（`-`）：檔案型別（`-` 表示一般檔案，`d` 表示目錄）
  - 接下來 9 個字元：擁有者、群組和其他人的權限
  - `r` = 讀取、`w` = 寫入、`x` = 執行
  
- **添加可執行權限**：使用 `chmod +x` 為所有人添加可執行權限。

  ```bash
  chmod +x questionnaire.sh
  ```

- **腳本組織**：結構化 bash 腳本的最佳實踐。
  - 以 shebang (`#!/bin/bash`) 開頭
  - 為你的腳本添加關於目的的描述性註解
  - 在頂部定義變數
  - 將相關的函式（程式）群組在一起
  - 主要腳本邏輯位於底部

  ```bash
  #!/bin/bash
  NAME="value"
  ARRAY=("item1" "item2")
  my_function() {
      echo "Function code here"
  }
  my_function
  echo "Script complete"
  ```

- **序列腳本執行**：創建主腳本以依序執行多個程式。
  - 適用於自動化涉及多個腳本的工作流程
  - 每個腳本在下一個開始之前會執行完成。
  - 可以將不同的程式合併成單一執行流程
  - 可以根據需要將引數傳遞給個別腳本。
  - 可以包含不同型別的程式（互動式、 自動化等）。

  ```bash
  #!/bin/bash
  ./setup.sh
  ./interactive.sh
  ./processing.sh
  ./cleanup.sh
  ```

# --assignment--

檢視 Bash 腳本主題和概念。
