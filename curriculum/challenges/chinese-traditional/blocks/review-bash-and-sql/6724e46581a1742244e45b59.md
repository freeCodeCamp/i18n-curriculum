---
id: 6724e46581a1742244e45b59
title: Bash 和 SQL 審查
challengeType: 31
dashedName: review-bash-and-sql
---

# --description--

## 資料庫正規化

這是組織關聯式資料庫以減少資料冗餘並提升完整性的處理程序。

它的利益包括：

- 將重複的資料降到最低，這樣可以節省儲存空間並減少不一致性。
- 透過使用主鍵和外鍵來強制執行資料完整性。
- 讓資料庫更容易維護和理解。

### 正常表單

- **1NF（第一正規化形式）**
  - 每個儲存格包含一個單一的（不可分割的）值。
  - 每個記錄都是唯一的（由主鍵強制執行）。
  - 列/行的順序無關緊要。
  - 範例：將多個電話號碼從 `students` 資料表移動到獨立的 `student_phones` 資料表中。

- **2NF（第二正規化形式）**
  - 符合 1NF 要求。
  - 沒有**部分相依性**：每個非鍵屬性必須依賴整個組合主鍵。
  - 範例：將 `orders` 資料表拆分為 `order_header` 和 `order_items`，以避免屬性只依賴於鍵的部分。

- **3NF（第三正規化形式）**
  - 符合 2NF 要求。
  - 沒有**傳遞依賴**：非鍵屬性不能依賴其他非鍵屬性。
  - 範例：將 `city_postal_code` 移動到 `cities` 資料表，而不是與每筆訂單一起儲存。

- **BCNF（Boyce-Codd 正規型）**
  - 符合 3NF 要求。
  - 每個決定項（函式相依性的左側）必須是超鍵。

**提示**：在大多數設計中，目標是達到 3NF，以取得完整性和效率的良好平衡。

## 關鍵 SQL 概念

- SQL 是用於與關聯式資料庫通訊的結構化查詢語言。
- **基本指令** → `SELECT`、`INSERT`、`UPDATE`、`DELETE`、`CREATE TABLE`、`ALTER TABLE` 等。
- `Joins` → 將多個資料表的資料合併（`INNER JOIN`、`LEFT JOIN`、`RIGHT JOIN`、`FULL JOIN`）。

## 在 Bash 中執行 SQL 指令

你可以使用 PostgreSQL 的 `psql` 命令列客戶端或其他資料庫的類似工具，直接從命令列執行 SQL 指令。

例如，要在 PostgreSQL 中執行一個 SQL 檔案：

```bash
psql -U username -d database_name -c "SELECT * FROM students;"
```

你也可以直接執行 MySQL 指令：

```bash
mysql -u username -p database_name -e "SELECT * FROM students;"
```

### 從檔案執行 SQL

```bash
# PostgreSQL
psql -U username -d database_name -f script.sql

# MySQL
mysql -u username -p database_name < script.sql
```

### 在 Bash 腳本中嵌入 SQL

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Insert student data
psql -U "$DB_USER" -d "$DB_NAME" -c \
"INSERT INTO students (name, age, major) VALUES ('Alice', 20, 'CS');"
```

### SQL 中變數的使用

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"
STUDENT_NAME="Bob"
AGE=21

psql -U "$DB_USER" -d "$DB_NAME" -c \
"INSERT INTO students (name, age) VALUES ('$STUDENT_NAME', $AGE);"
```

**提示**：清理變數以避免 SQL 注入。

## 在 Bash 中擷取和使用 SQL 查詢結果

當你透過 `psql` 執行 SQL 查詢時，你可以在你的 Bash 腳本中**擷取**並**處理**傳回的值。

### 擷取單一值

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get total student count
STUDENT_COUNT=$(psql -U "$DB_USER" -d "$DB_NAME" -t -A -c \
"SELECT COUNT(*) FROM students;")

echo "Total students: $STUDENT_COUNT"
```

輸出 → 42

### 擷取多個行

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get top 3 students' names and ages
RESULTS=$(psql -U "$DB_USER" -d "$DB_NAME" -t -A -F"," -c \
"SELECT name, age FROM students LIMIT 3;")

echo "Top 3 students:"
echo "$RESULTS"
```

輸出

```bash
Alice,20
Bob,21
Charlie,22
```

### 迴圈遍歷查詢結果

```bash
#!/bin/bash
DB_USER="school_admin"
DB_NAME="school"

# Get student names and majors
psql -U "$DB_USER" -d "$DB_NAME" -t -A -F"," -c \
"SELECT name, major FROM students;" | while IFS="," read -r name major
do
    echo "Student: $name | Major: $major"
done
```

輸出形狀

```bash
Student: Alice | Major: CS
Student: Bob   | Major: Math
Student: Carol | Major: Physics
```

## SQL 注入

這是一種網路安全漏洞，攻擊者會將惡意的 SQL 程式碼插入輸入欄位，以操控資料庫。

這可能導致像以下的風險行為：

- 繞過身份驗證。
- 竊取敏感資料。
- 修改或刪除記錄。

SQL 注入攻擊的範例：

```sql
SELECT * FROM users WHERE username = ' " " OR "1"="1" -- ' AND password = 'anything';
```

此查詢會傳回所有使用者，因為條件 `OR "1"="1"` 永遠為真，讓攻擊者能繞過登入檢查。

### 防止 SQL 注入

1. **使用 Prepared Statements**：這些將 SQL 程式碼與資料分離，防止注入。以下是一個範例（Node.js 搭配 pg）：

    ```sql
    client.query('SELECT * FROM users WHERE username = $1 AND password = $2', [username, password]);
    ```

2. **輸入驗證**：清理並驗證所有使用者輸入，以確保其符合預期格式。

3. **最小權限**：使用具有應用程式所需最低權限的資料庫帳號。

**注意**：切勿授予應用程式帳戶管理員權限。

## N+1 問題

N+1 問題發生在應用程式執行一次查詢以取得項目（N）的列表，然後對每個項目執行額外查詢以取得相關資料，導致執行 N+1 次查詢。

**為什麼這樣不好**

- 每個查詢都會增加網路和處理程序的額外負擔。
- 多個小查詢比一個最佳化的查詢更慢。

### N+1 樣式範例

```sql
-- 1: Get list of orders
SELECT * FROM orders LIMIT 50;

-- N: For each order, get customer
SELECT * FROM customers WHERE customer_id = ...;
```

**解決方案**：使用 `JOINs` 或其他基於集合的操作。

```sql
SELECT 
  orders.order_id,
  orders.product,
  orders.quantity,
  customers.customer_id,
  customers.name,
  customers.email,
  customers.address
FROM orders
JOIN customers 
  ON orders.customer_id = customers.customer_id
WHERE orders.order_id IN (SELECT order_id FROM orders LIMIT 50);
```

始終尋找將相關資料合併到單一查詢中的機會。

# --assignment--

檢視 Bash 和 SQL 主題與概念。
